branches:
  default:
    stage: mytest

stages:
  mytest:
    worker:
        type: docker
        path: eve/centos7-ctxt
    steps:
      - TriggerStages:
          name: trigger a build on a sub-docker
          stage_names:
            - subtest
          waitForFinish: True
          haltOnFailure: True

  subtest:
    worker:
      type: docker
      path: eve/centos7-ctxt
      volumes:
        - 'testcache:/write'
    steps:
      - ShellCommand:
          name: make sure remnants of cache file are removed
          command: >
            sh -c "([ -f /write/file ] && [ $(cat /write/file) = '2nd' ] && rm /write/file) || true"
      - ShellCommand:
          name: save this execution (1st or 2nd)
          command: >
            sh -c "[ -f /write/file ] && echo 2nd > /write/file || echo 1st > /write/file"
      - ShellCommand:
          name: kill slave on first run then pass
          command: >
            [ $(cat /write/file) = '1st' ]
            && pkill --signal SIGKILL -f buildbot-worker
            || true
