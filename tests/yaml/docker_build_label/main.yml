branches:
  default:
    stage: "build-docker-image"

stages:
  build-docker-image:
    worker:
        type: "docker"
        path: "eve/ubuntu-trusty-with-docker-ctxt"
    steps:
      - SetProperty:
          name: "set ts label name"
          property: "label"
          value: "eve.build.ts"
      - SetPropertyFromCommand:
          name: "get '%(prop:label)s' label value"
          property: "label_value"
          command: >
            docker inspect \
              -f '{{ index .Config.Labels "%(prop:label)s" }}' \
              '%(prop:docker_image)s'
          logEnviron: False
      - ShellCommand:
          name: "check '%(prop:label)s' label value timestamp is correct"
          command: >
            set -exv;

            test -n '%(prop:label_value)s';

            now="$(date +%%s)";
            test '%(prop:label_value)s' -gt "$(($now - 300))" -a \
                 '%(prop:label_value)s' -le "$now";
          logEnviron: False
