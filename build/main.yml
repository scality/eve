---
version: 0.2

branches:
  feature/*, improvement/*, bugfix/*, w/*, q/*:
    stage: pre-merge

stages:
  pre-merge:
    worker:
      type: docker
      path: build/workers/xenial
      volumes:
        - '/home/eve/workspace'
    steps:
      - Git:
          name: fetch source
          repourl: "%(prop:git_reference)s"
          shallow: True
          retryFetch: True
      - ShellCommand:
          name: generate a big artifact
          command: >
              mkdir big
              && cd big
              && dd if=/dev/urandom of=data bs=1M count=3000
              && sha1sum data > data.sha1
          haltOnFailure: True
      - Upload:
          source: big
          alwaysRun: True
          urls:
              - data*
      - ShellCommand:
          name: check downloads integrity under stress
          command: "./check_multiple_big_downloads.sh"
          haltOnFailure: True
      - ShellCommand:
          name: add successful .final_status to artifacts
          command: >
              mkdir build_status
              && echo -n "SUCCESSFUL" > build_status/.final_status
          haltOnFailure: True
      - ShellCommand:
          name: add failed .final_status to artifacts if needed
          command: >
              [ -f build_status/.final_status ]
              || ( mkdir build_status && echo -n "FAILED" > build_status/.final_status )
          haltOnFailure: True
          alwaysRun: True
      - Upload:
          source: build_status
          alwaysRun: True
