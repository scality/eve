# double reverse proxy cache for git-lfs
proxy_cache_path  /data/nginx/cache_atlassian levels=1:2 keys_zone=atlassian:8m inactive=30d max_size=16g;

# GIT
server {
	listen 80 default_server;
	listen [::]:80 default_server;
	root /var/www/html;
	index index.html index.htm index.nginx-debian.html;

	server_name _;

	# git static
	location ~ ^.*\.git/objects/([0-9a-f]+/[0-9a-f]+|pack/pack-[0-9a-f]+.(pack|idx))$ {
	    root /var/lib/git;
    }

    # git http-backend
    proxy_connect_timeout       610;
    proxy_send_timeout          610;
    proxy_read_timeout          610;
    send_timeout                610;
    proxy_max_temp_file_size      0;

    # disable keep-alive to avoid upstream timeouts
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    location ~ ^.*\.git/(HEAD|info/refs|objects/info/.*|git-(upload|receive)-pack)$ {
        fastcgi_read_timeout 900;

        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /usr/lib/git-core/git-proxy-cache-and-http-backend;
        fastcgi_param GIT_HTTP_EXPORT_ALL "";
        fastcgi_param GIT_PROJECT_ROOT /var/lib/git;
        fastcgi_param PATH_INFO $uri;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_index /root/git-upload-pack.py;
        fastcgi_pass unix:/var/run/fcgiwrap.socket;
    }
}

# GIT LFS
server {
    listen 81 default_server;
    listen [::]:81 default_server;
    server_name _;

    resolver 8.8.8.8 ipv6=off

    location /bitbucket {
            rewrite /bitbucket/(.*) /$1 break;

            # define reverse proxy
            proxy_pass             https://bitbucket.org/;
            proxy_set_header       Host bitbucket.org;
            proxy_set_header       Authorization "Basic ROBOT_BASE64";

            # filter to make links point to the second reverse proxy
            sub_filter 'https://media-api.atlassian.io/' http://$http_host/eve_gitlfs_cache/bitbucket/;
            sub_filter_types application/vnd.git-lfs+json;
            sub_filter_once off;

            # define cache
            proxy_buffer_size        16k;
            proxy_buffers            8 16k;
            proxy_busy_buffers_size  32k;
            proxy_ignore_headers     Cache-Control;
    }

    location /eve_gitlfs_cache/bitbucket {
            rewrite /eve_gitlfs_cache/bitbucket/(.*) /$1 break;

            # define reverse proxy
            proxy_pass             https://media-api.atlassian.io/;
            proxy_set_header       Host media-api.atlassian.io;

            # define cache
            proxy_buffer_size        16k;
            proxy_buffers            8 16k;
            proxy_busy_buffers_size  32k;
            proxy_ignore_headers     Cache-Control;
            proxy_cache              atlassian;
            proxy_cache_methods      GET HEAD;
            proxy_cache_valid        200  30d;
            proxy_cache_use_stale    error timeout invalid_header updating http_500 http_502 http_503 http_504;
    }
}
