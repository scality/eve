image: python:2.7

pipelines:
  default:
    - step:
        script:
          # Reading certificates from environment variables and

          # converting them to files
          - python create-files-for-bitbucket-pipelines.py

          # fixing git certificate
          - mkdir -p ~/.ssh/
          - cp certs/git/id_rsa ~/.ssh/
          - chmod 600 ~/.ssh/id_rsa
          - ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          - git clone git@bitbucket.org:scality/test-eve.git

          # installing tox
          - pip install tox

          # Launching static checks tests
          # - tox -e static || exit 0 # FIXME: too many pylint errors

          # Setting up CARINA Docker environment and variables
          - eval $(python deploy/carina_setup_env.py eve_cluster_test)

          # Launching tests
          - HTTP_PORT="" PB_PORT="" REPO="" tox -e test

          # Deplying eve for the eve-test repo
          - HTTP_PORT=8998 PB_PORT=9998 REPO=eve-test tox -e deploy


  branches:
    development/*:
      - step:
          script:
            python deploy/deploy_eve_master.py scality wall-e
  branches:
    release/*:
      - step:
          script:
            python deploy/deploy_eve_master.py scality ring